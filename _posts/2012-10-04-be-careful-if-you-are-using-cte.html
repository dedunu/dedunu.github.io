---
layout: post
title: Be careful if you are using CTE!
date: '2012-10-04T19:38:00.000+03:00'
author: Dedunu Dhananjaya
tags:
- SQL
- CTE
- T-SQL
- TSQL
- SQL Server
modified_time: '2019-07-09T17:25:12.141+03:00'
blogger_id: tag:blogger.com,1999:blog-8327060682734922468.post-1372982064995265812
permalink: www.dedunu.info/2012/10/be-careful-if-you-are-using-cte.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div align="justify"><a href="https://dedunumax.wordpress.com/2012/09/25/common-table-expressions-cte/" target="_blank">Previously I wrote a post about CTE</a> (Common Table Expressions). And Common Table Expressions are valid for a single statement only. But a single statement can use many CTEs. And statement also should be within the same batch.</div><div align="justify"><pre class="code"><span style="color: blue;">USE </span><span style="color: teal;">AdventureWorks2012</span><span style="color: blue;">GO<br /></span><span style="color: green;">--Defining CTE</span><span style="color: blue;">WITH </span><span style="color: teal;">ctePerson </span><span style="color: blue;">AS</span><span style="color: grey;">(<br />    </span><span style="color: blue;">SELECT </span><span style="color: grey;">* <br />    </span><span style="color: blue;">FROM </span><span style="color: teal;">Person</span><span style="color: grey;">.</span><span style="color: teal;">Person</span><span style="color: grey;">)</span><span style="color: green;">--First Statement will run </span><span style="color: blue;">SELECT </span><span style="color: teal;">FirstName </span><span style="color: blue;">FROM </span><span style="color: teal;">ctePerson </span><span style="color: green;">--Second statement will occur an error</span><span style="color: blue;">SELECT </span><span style="color: teal;">FirstName </span><span style="color: blue;">FROM </span><span style="color: teal;">ctePerson</span></pre></div><br /><div align="justify">And in my previous post, I have mentioned about many CTEs for one statement. And there is another important note that is to be careful when you are naming CTEs. Take a look on below example.</div><br /><div align="justify"><pre class="code"><span style="color: blue;">USE </span><span style="color: teal;">tempdb</span><span style="color: blue;">GO<br /></span><span style="color: green;">--Creating two tables</span><span style="color: blue;">CREATE TABLE </span><span style="color: teal;">cteSampletbl1</span><span style="color: grey;">(</span><span style="color: teal;">id </span><span style="color: blue;">int</span><span style="color: grey;">,</span><span style="color: teal;">name </span><span style="color: blue;">varchar</span><span style="color: grey;">(</span>50<span style="color: grey;">)<br />)</span><span style="color: blue;">GO<br /><br />CREATE TABLE </span><span style="color: teal;">cteSampletbl2</span><span style="color: grey;">(</span><span style="color: teal;">id </span><span style="color: blue;">int</span><span style="color: grey;">,</span><span style="color: teal;">name </span><span style="color: blue;">varchar</span><span style="color: grey;">(</span>50<span style="color: grey;">)<br />)</span><span style="color: blue;">GO<br /></span><span style="color: green;">--Populating tables</span><span style="color: blue;">INSERT INTO </span><span style="color: teal;">cteSampletbl1 </span><span style="color: blue;">VALUES</span><span style="color: grey;">(</span>1<span style="color: grey;">,</span><span style="color: red;">'Satheeq'</span><span style="color: grey;">),<br />(</span>2<span style="color: grey;">,</span><span style="color: red;">'Preethi'</span><span style="color: grey;">),<br />(</span>3<span style="color: grey;">,</span><span style="color: red;">'Dinesh'</span><span style="color: grey;">),<br />(</span>4<span style="color: grey;">,</span><span style="color: red;">'Angelo'</span><span style="color: grey;">)</span><span style="color: blue;">GO<br /><br />INSERT INTO </span><span style="color: teal;">cteSampletbl2 </span><span style="color: blue;">VALUES</span><span style="color: grey;">(</span>1<span style="color: grey;">,</span><span style="color: red;">'Shamil'</span><span style="color: grey;">),<br />(</span>2<span style="color: grey;">,</span><span style="color: red;">'Hasitha'</span><span style="color: grey;">),<br />(</span>3<span style="color: grey;">,</span><span style="color: red;">'Abhinandana'</span><span style="color: grey;">),<br />(</span>4<span style="color: grey;">,</span><span style="color: red;">'Susantha'</span><span style="color: grey;">)</span><span style="color: blue;">GO<br /></span><span style="color: green;">/*<br />    This CTE is defined with existing table name without any error<br />*/</span><span style="color: blue;">WITH </span><span style="color: teal;">cteSampletbl2</span><span style="color: blue;">AS</span><span style="color: grey;">(<br />    </span><span style="color: blue;">SELECT </span><span style="color: grey;">* </span><span style="color: blue;">FROM </span><span style="color: teal;">cteSampletbl1</span><span style="color: grey;">)</span><span style="color: green;">--This statement uses CTE</span><span style="color: blue;">SELECT </span><span style="color: grey;">* </span><span style="color: blue;">FROM </span><span style="color: teal;">cteSampletbl2</span><span style="color: green;">--This statement uses existing table</span><span style="color: blue;">SELECT </span><span style="color: grey;">* </span><span style="color: blue;">FROM </span><span style="color: teal;">cteSampletbl2<br /></span><span style="color: green;">--Dropping tables</span><span style="color: blue;">DROP TABLE </span><span style="color: teal;">cteSampletbl1</span><span style="color: blue;">DROP TABLE </span><span style="color: teal;">cteSampletbl2</span><span style="color: blue;">GO</span></pre></div><br /><div align="justify">Below example it lets us create a CTE with a name of an existing table without any warnings or errors. And it gives priority to CTE in the first statement. Then it uses the existing table in the second statement. So it would be a best practice to use a separate prefix for CTEs. Then take a look into the next sample which is taken from <a href="http://dbfriend.blogspot.com/" target="_blank">Dinesh’s</a> presentation for <a href="http://www.sqlserveruniverse.com/" target="_blank">SQL Server Universe Group</a>.</div><br /><div align="justify"><pre class="code"><span style="color: blue;">USE </span><span style="color: teal;">tempdb</span><span style="color: blue;">GO<br /></span><span style="color: green;">--Creating two tables</span><span style="color: blue;">CREATE TABLE </span><span style="color: teal;">cteSampletbl1</span><span style="color: grey;">(</span><span style="color: teal;">id </span><span style="color: blue;">int</span><span style="color: grey;">,</span><span style="color: teal;">name </span><span style="color: blue;">varchar</span><span style="color: grey;">(</span>50<span style="color: grey;">)<br />)</span><span style="color: blue;">GO<br /></span><span style="color: green;">--Populating tables</span><span style="color: blue;">INSERT INTO </span><span style="color: teal;">cteSampletbl1 </span><span style="color: blue;">VALUES</span><span style="color: grey;">(</span>1<span style="color: grey;">,</span><span style="color: red;">'Satheeq'</span><span style="color: grey;">),<br />(</span>2<span style="color: grey;">,</span><span style="color: red;">'Preethi'</span><span style="color: grey;">),<br />(</span>3<span style="color: grey;">,</span><span style="color: red;">'Dinesh'</span><span style="color: grey;">),<br />(</span>4<span style="color: grey;">,</span><span style="color: red;">'Angelo'</span><span style="color: grey;">)</span><span style="color: blue;">GO<br /></span><span style="color: green;">--This CTE got error</span><span style="color: blue;">WITH </span><span style="color: teal;">cteSampletbl1</span><span style="color: blue;">AS</span><span style="color: grey;">(<br />    </span><span style="color: green;">--Same name could not be used as name and in CTE<br />    </span><span style="color: blue;">SELECT </span><span style="color: grey;">* </span><span style="color: blue;">FROM </span><span style="color: teal;">cteSampletbl1</span><span style="color: grey;">)</span><span style="color: blue;">SELECT </span><span style="color: grey;">* </span><span style="color: blue;">FROM </span><span style="color: teal;">cteSampletbl1<br /></span><span style="color: green;">--This CTE don’t have any error</span><span style="color: blue;">WITH </span><span style="color: teal;">cteSampletbl1</span><span style="color: blue;">AS</span><span style="color: grey;">(<br />    </span><span style="color: green;">--full name of object should provide<br />    </span><span style="color: blue;">SELECT </span><span style="color: grey;">* </span><span style="color: blue;">FROM </span><span style="color: teal;">dbo</span><span style="color: grey;">.</span><span style="color: teal;">cteSampletbl1</span><span style="color: grey;">)</span><span style="color: blue;">SELECT </span><span style="color: grey;">* </span><span style="color: blue;">FROM </span><span style="color: teal;">cteSampletbl1<br /></span><span style="color: green;">--Dropping tables</span><span style="color: blue;">DROP TABLE </span><span style="color: teal;">cteSampletbl1</span><span style="color: blue;">GO</span></pre></div><br /><div align="justify">You can’t use the same table name as the name of the CTE and inside the CTE.</div></div>